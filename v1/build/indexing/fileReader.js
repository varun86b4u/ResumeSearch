/*! resume 2015-11-19 */
var fs=require("fs"),path=require("path"),mime=require("mime"),conf=require("../config/config"),atob=require("atob"),isEv=atob(conf.ev),mic=parseInt(atob(conf.mic),10),readFileInBatch=function(a,b,c,d,e,f){var g=d.slice(b,b+a);console.log("list1",g.length,d.length,b,a),readFilesFromList(g,function(h,i){e=e.concat(i),console.log(e.length,d.length),e.length==d.length?c(null,e):(f&&f(),b+=g.length,console.log(b,d.length),readFileInBatch(a,b,c,d,e))})},readFilesFromList=function(a,b){var c=[];console.log("list1",a.length),a.forEach(function(d){try{getFileBase64String(d,function(e,f){f&&(e="");var g={path:d,data:e};c.push(g),c.length==a.length&&(console.log("list1",a.length),b(null,c))})}catch(e){var f={path:d,data:""};c.push(f),c.length==a.length&&b(null,c)}})},getFileBase64String=function(a,b){fs.readFile(a,"base64",function(a,c){b(c,a)})},walk=function(a,b){var c=[];fs.readdir(a,function(d,e){if(d)return b(d);var f=e.length;return f?void e.forEach(function(d){d=path.resolve(a,d),fs.stat(d,function(a,e){e&&e.isDirectory()?walk(d,function(a,d){c=c.concat(d),--f||b(null,c)}):(c.push(d),--f||b(null,c))})}):b(null,c)})},cntRestrict=function(a){var b=a;return"true"==isEv&&a.length>mic&&(b=a.slice(0,mic)),b},readFilesFromDir=function(a,b,c){var d=[];walk(a,function(a,e){if(e&&e.length>0){e=cntRestrict(e);var f=500;readFileInBatch(f,0,c,e,d,b)}})},getFileData=function(a,b){var c=mime.lookup(a);fs.readFile(a,function(a,d){b.contentType(c),b.send(d)})},removeFile=function(a,b){fs.unlinkSync(a)};module.exports={readFilesFromDir:readFilesFromDir,getFileData:getFileData,removeFile:removeFile};